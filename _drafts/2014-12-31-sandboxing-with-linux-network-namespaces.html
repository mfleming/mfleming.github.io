---
layout: post
title: Sandboxing with Linux network namespaces
date: '2014-12-31T04:56:00.002-08:00'
author: Matt Fleming
tags:
- linux
- technical
- network
modified_time: '2015-01-10T03:06:23.757-08:00'
blogger_id: tag:blogger.com,1999:blog-5657688967837431090.post-6619871840497373300
blogger_orig_url: http://www.codeblueprint.co.uk/2014/12/sandboxing-with-linux-network-namespaces.html
---

<span style="font-family: inherit;">Like most large corporations, my <a href="http://www.intel.com/">current employer</a>&nbsp;uses a Virtual Private Network (VPN) to allow remote employees to connect to the internal network. We've got setup scripts that make it trivial to configure things for new starters, and this being the <a href="https://01.org/">Open Source Technology Center</a>, things work great out of the box on Linux.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">But for a while now, I've wanted a way to isolate the connection to the VPN at the <i>application level</i>&nbsp;to...</span><br /><ul><li><span style="font-family: inherit;">partition VPN and non-VPN network traffic&nbsp;</span></li><li><span style="font-family: inherit;">sandbox applications</span></li></ul><span style="font-family: inherit;">Currently, when I connect to the VPN <b>all</b>&nbsp;of my network traffic is routed through the corporate network. This incurs substantial network latency, even when accessing public addresses. While it's true that I could split traffic based on IP routes (so the VPN link is only used to access internal addresses), that approach is generally frowned upon because it's way too easy for internal traffic to leak onto public networks. Splitting traffic via routes also requires manually maintaining those routes, and that's just not sustainable.</span><br /><div><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">Another drawback is that every single application running on my laptop has access to the resources on the VPN - whether they require it or not. In reality, there are only a handful of applications that I run that absolutely must be able to access the internal network (mail, IRC and web browser). Being able to selectively grant VPN access would be a huge improvement.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit; font-size: large;">Namespaces in Linux</span></div><div><span style="font-family: inherit;">The solution to my problem is <a href="http://lwn.net/Articles/531114/" rel="nofollow">namespaces</a>. Using separate network namespaces allows me to hard partition network traffic. If I generate traffic outside of the dedicated VPN namespace, it's impossible for it to make its way onto the VPN. On the flipside, traffic inside the VPN namespace <i>always</i>&nbsp;goes across the VPN.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">Because namespaces are a per-thread resource on Linux, I can pick exactly which applications have access to the VPN using tools like&nbsp;<cite>nsenter(1)</cite> and <cite>ip-netns(8)<span style="font-style: normal;">&nbsp;to modify the namespace of a process.</span></cite></span></div><div><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">Now, one quirk of the namespace API is that it's not possible to modify the namespaces of some other already running process, i.e. the <i>setns(2)</i>&nbsp;libc prototype looks like this,</span><br /><pre>    int setns(int fd, int nstype);<br /></pre><span style="font-family: inherit;">A process can modify its own namespace, but not that of another process (there's no <cite>pid_t</cite> argument.</span><br /><span style="font-family: inherit;"><br /></span><div><span style="font-family: inherit;">I'm using <a href="http://www.infradead.org/openconnect/">OpenConnect</a>&nbsp;plugin for NetworkManager on my Fedora 20 laptop. There are a multitude of resources on the web for configuring openconnect and NetworkManager, so I won't cover that here. What I am going to discuss is how to sandbox applications that connect to a VPN using network and mount namespaces.</span><br /><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">A key piece is that network devices can be moved into network namespaces even after they've been brought up. So it's possible to use NetworkManager and openconnect to connect to the VPN from the default network namespace and then reassign vpn0 to the VPN namespace.</span><br /><div><span style="font-family: inherit;"><br /></span></div><span style="font-family: inherit;">There's a handy application for interacting with NetworkManager from within scripts, <cite>nmcli(1)</cite>. </span><br /><pre><span style="font-family: inherit;">    nmcli connection up "Work VPN"</span></pre><div><span style="font-family: inherit;">Since NetworkManager modifies resolv.conf when obtaining an IP address for the VPN via DHCP, it's necessary to have a separate copy of <code>/etc/resolv.conf</code> for each network namespace.</span></div><div><span style="font-family: inherit;"><br /></span><span style="font-family: inherit;">To do this, simply unshare the default mount namespace with, </span><br /><pre><span style="font-family: inherit;">    unshare -m [command]</span></pre></div><div><span style="font-family: inherit; font-size: large;">Putting it all together</span></div><div><span style="font-family: inherit;">Here's the simple shell script that I use to initialise a dedicated network namespace and to run commands in the context of that network namespace.</span><br /><pre><span style="font-family: inherit;">    #!/bin/bash<br />    #<br />    #  Run as unshare -m &lt;script&gt;<br /><br />    # Create new private mount point so that NetworkManager's DHCP<br />    # changes only affect our isolated namespace.<br />    touch /tmp/resolv.conf<br />    mount -B /tmp/resolv.conf /etc/resolv.conf<br />    nmcli connection up "Work VPN"<br /><br />    ip netns add "vpn-namespace"<br />    ip link set dev vpn0 netns "vpn-namespace"<br /></span></pre><span style="font-family: inherit;"><span style="font-size: large;">Future work</span></span><br /><span style="font-family: inherit;">The above scripts falls short of a robust solution. For a start, things don't work correctly when I get disconnected from the VPN, e.g. across a suspend/resume cycle.</span><br /><ul><li><span style="font-family: inherit;">Suspend/resume</span></li><li><span style="font-family: inherit;">libvirt</span></li></ul></div><span style="font-family: inherit; font-size: large; font-weight: normal;">References</span><br /><a href="http://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/"><span style="font-family: inherit;">[0] - http://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/</span></a></div></div>